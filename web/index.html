<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haze Now Playing</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #000000;
    font-family: 'Geist', sans-serif;
    -webkit-font-smoothing: antialiased;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    padding: 0;
  }

  .widget {
    width: 480px;
    background: rgba(10, 10, 12, 0.92);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 16px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    overflow: hidden;
  }

  /* Top row: art + info */
  .top {
    display: flex;
    gap: 14px;
    align-items: center;
  }

  .art {
    width: 72px;
    height: 72px;
    border-radius: 8px;
    background: #1a1a1e;
    flex-shrink: 0;
    overflow: hidden;
    position: relative;
  }

  .art img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.3s ease;
  }

  .art-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .label {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.3);
    margin-bottom: 4px;
  }

  .title {
    font-size: 15px;
    font-weight: 600;
    color: #ffffff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
    transition: opacity 0.2s ease;
  }

  .artist {
    font-size: 13px;
    font-weight: 400;
    color: rgba(255,255,255,0.55);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
  }

  .album {
    font-size: 12px;
    font-weight: 300;
    color: rgba(255,255,255,0.3);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
    margin-top: 1px;
  }

  /* Progress */
  .progress-section {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .progress-track {
    height: 2px;
    background: rgba(255,255,255,0.1);
    border-radius: 99px;
    position: relative;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: #ffffff;
    border-radius: 99px;
    width: 0%;
    transition: width 1s linear;
  }

  .progress-times {
    display: flex;
    justify-content: space-between;
  }

  .time {
    font-size: 10px;
    font-weight: 400;
    color: rgba(255,255,255,0.25);
    font-variant-numeric: tabular-nums;
  }

  /* Next up */
  .next {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-top: 2px;
    border-top: 1px solid rgba(255,255,255,0.06);
  }

  .next-label {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.2);
    flex-shrink: 0;
  }

  .next-name {
    font-size: 11px;
    font-weight: 400;
    color: rgba(255,255,255,0.35);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Animated playing indicator */
  .playing-bars {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 12px;
    flex-shrink: 0;
  }

  .bar {
    width: 2px;
    background: rgba(255,255,255,0.4);
    border-radius: 1px;
    transform-origin: bottom;
  }

  .bar.active {
    animation: bounce var(--dur) ease-in-out infinite alternate;
  }

  @keyframes bounce {
    from { transform: scaleY(0.15); }
    to   { transform: scaleY(1); }
  }

  .title.fade { opacity: 0; }
</style>
</head>
<body>
<div class="widget">

  <div class="top">
    <div class="art">
      <img id="art-img" src="/art" alt="" style="display:none">
      <div class="art-placeholder" id="art-ph">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
        </svg>
      </div>
    </div>

    <div class="info">
      <div class="label">Now Playing</div>
      <div class="title" id="title">—</div>
      <div class="artist" id="artist">—</div>
      <div class="album" id="album">—</div>
    </div>

    <div class="playing-bars" id="bars">
      <div class="bar" style="height:12px;--dur:0.5s"></div>
      <div class="bar" style="height:12px;--dur:0.7s"></div>
      <div class="bar" style="height:12px;--dur:0.4s"></div>
      <div class="bar" style="height:12px;--dur:0.6s"></div>
    </div>
  </div>

  <div class="progress-section">
    <div class="progress-track">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <div class="progress-times">
      <span class="time" id="elapsed">0:00</span>
      <span class="time" id="duration">—</span>
    </div>
  </div>

  <div class="next" id="next-row" style="display:none">
    <span class="next-label">Next</span>
    <span class="next-name" id="next-name">—</span>
  </div>

</div>

<script>
const WS_PORT = location.port ? parseInt(location.port) + 1 : 8081;
const WS_URL = `ws://${location.hostname}:${WS_PORT}`;
let ws = null, state = {}, progressTimer = null, trackStart = null;

function connect() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => {};
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'track_change') { trackStart = Date.now(); crossfade(data); }
    else apply(data);
  };
  ws.onclose = () => setTimeout(connect, 2000);
  ws.onerror = () => ws.close();
}

function crossfade(data) {
  const el = document.getElementById('title');
  el.classList.add('fade');
  setTimeout(() => { apply(data); el.classList.remove('fade'); }, 200);
}

function apply(data) {
  state = data;
  const t = data.track || {};
  const playing = data.state === 'PLAYING';

  document.getElementById('title').textContent = t.title || '—';
  document.getElementById('artist').textContent = t.artist || '—';
  document.getElementById('album').textContent = t.album
    ? t.album + (t.year ? ` (${t.year})` : '')
    : '—';

  const bars = document.querySelectorAll('.bar');
  bars.forEach(b => b.classList.toggle('active', playing));

  if (t.duration) {
    const m = Math.floor(t.duration/60), s = Math.floor(t.duration%60);
    document.getElementById('duration').textContent = `${m}:${s.toString().padStart(2,'0')}`;
  } else document.getElementById('duration').textContent = '—';

  const img = document.getElementById('art-img'), ph = document.getElementById('art-ph');
  if (t.has_art) {
    img.src = `/art?t=${Date.now()}`; img.style.display = ''; ph.style.display = 'none';
  } else { img.style.display = 'none'; ph.style.display = 'flex'; }

  const nextRow = document.getElementById('next-row');
  if (data.pending_playlist) {
    nextRow.style.display = 'flex';
    document.getElementById('next-name').textContent = data.pending_playlist;
  } else nextRow.style.display = 'none';

  stopProgress();
  if (playing) startProgress(t.duration);
}

function startProgress(dur) {
  if (!trackStart) trackStart = Date.now();
  progressTimer = setInterval(() => {
    const el = (Date.now() - trackStart) / 1000;
    const m = Math.floor(el/60), s = Math.floor(el%60);
    document.getElementById('elapsed').textContent = `${m}:${s.toString().padStart(2,'0')}`;
    if (dur) document.getElementById('progress-fill').style.width = Math.min(100, el/dur*100) + '%';
  }, 500);
}

function stopProgress() { if (progressTimer) { clearInterval(progressTimer); progressTimer = null; } }

connect();
</script>
</body>
</html>